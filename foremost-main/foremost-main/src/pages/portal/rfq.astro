---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PortalGuard from '../../components/PortalGuard.astro';
import { companyInfo } from '../../config/company';

const rfqEndpoint = import.meta.env.PUBLIC_RFQ_FORM_ENDPOINT ?? '';
---
<BaseLayout title="Portal RFQ | Foremost Machine, Inc.">
  <PortalGuard heading="RFQ Request">
    <p class="mb-4 text-slate-300">If you do not yet have secure portal credentials, use the fallback RFQ form below.</p>
    <form id="portal-rfq-form" method="POST" action={rfqEndpoint} enctype="multipart/form-data" class="space-y-4">
      <div class="grid gap-4 md:grid-cols-2">
        <label class="block"><span class="mb-1 block text-sm text-slate-200">Company *</span><input required autocomplete="organization" name="company" type="text" class="w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2" /></label>
        <label class="block"><span class="mb-1 block text-sm text-slate-200">Contact *</span><input required autocomplete="name" name="contact" type="text" class="w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2" /></label>
        <label class="block md:col-span-2"><span class="mb-1 block text-sm text-slate-200">Part description *</span><textarea required name="part-description" rows="4" class="w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2"></textarea></label>
      </div>
      <p class="text-sm text-slate-300">Need to send CAD immediately? Email <a class="text-brand-100 underline" href={`mailto:${companyInfo.rfqEmail}`}>{companyInfo.rfqEmail}</a>.</p>
      <p id="portal-rfq-success" class="hidden rounded-md border border-emerald-400/50 bg-emerald-900/20 px-3 py-2 text-sm text-emerald-200">RFQ submitted. Our quoting team will follow up.</p>
      <p id="portal-rfq-error" class="hidden rounded-md border border-red-400/50 bg-red-900/20 px-3 py-2 text-sm text-red-200">RFQ submission failed. Please retry or email us directly.</p>
      <button type="submit" class="rounded-md bg-brand-500 px-4 py-2 font-semibold text-white hover:bg-brand-700">Submit RFQ</button>
    </form>

    <script define:vars={{ rfqEndpoint }} is:inline>
      const rfqForm = document.getElementById('portal-rfq-form');
      const successNotice = document.getElementById('portal-rfq-success');
      const errorNotice = document.getElementById('portal-rfq-error');

      rfqForm?.addEventListener('submit', async (event) => {
        if (!(rfqForm instanceof HTMLFormElement) || !rfqEndpoint) {
          return;
        }

        event.preventDefault();
        successNotice?.classList.add('hidden');
        errorNotice?.classList.add('hidden');

        const body = new FormData(rfqForm);

        try {
          const response = await fetch(rfqEndpoint, {
            method: 'POST',
            body,
            headers: { Accept: 'application/json' }
          });

          if (!response.ok) {
            throw new Error('Submission failed');
          }

          rfqForm.reset();
          successNotice?.classList.remove('hidden');
        } catch {
          errorNotice?.classList.remove('hidden');
        }
      });
    </script>
  </PortalGuard>
</BaseLayout>
